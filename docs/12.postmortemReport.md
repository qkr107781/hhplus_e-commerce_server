# **📝 Redis Sentinel 기반 쿠폰 발급 시스템 장애 보고서**

## **1. 현상**

### **타임라인**

- **03:00**: Redis Master 프로세스 다운 (쿠폰 발급 서비스 핵심 데이터 저장소)
- **03:01**: Sentinel들이 장애 감지, 새로운 Master 선출 시작
- **03:02**: Replica1이 새로운 Master로 승격
- **03:02~03:06**: Replica2 → 새로운 Master로 데이터 동기화 과정에서 지연 발생
- **03:03~03:06**: 애플리케이션 레이어에서 4초 단위로 요청 처리 시간 급증 (평균 50ms → 순간 5s)
- **03:07**: Replica2 동기화 완료, 처리 지연 정상화

### **영향 범위**

- **쿠폰 발급 요청 API** 응답 지연
- Redis를 직접 의존하는 **쿠폰 유효성 체크/발급 중복 방지 로직** 지연

### **고객 영향도 (비즈니스 임팩트)**

- 4분간 쿠폰 발급 서비스 정상 동작 불가
- 약 3,000명의 사용자가 **쿠폰 발급 실패** 또는 **지연된 발급 결과 수신**
- 선착순 쿠폰 이벤트의 **공정성 훼손** → 일부 고객 불만 및 CS 유입

---

## **2. 조치 내용**

### **장애 원인**

- Redis Master 장애로 Sentinel이 Replica를 Master로 승격했으나
- Replica → Master 동기화 지연으로 인해 **데이터 읽기/쓰기 지연** 발생
- 해당 지연이 애플리케이션 응답 시간 튐으로 노출

### **해소 타임라인**

- **03:00~03:07** 장애 발생
- **03:07** 동기화 완료 후 정상화

### **실제 단기 대응책**

- 장애 감지 직후 애플리케이션에서 **일시적 쿠폰 발급 중단 → “잠시 후 다시 시도” 메시지 노출**
- Redis 동기화 완료 후 정상 처리 재개
- 긴급 알림 → 고객센터 공지

### **후속 대응 계획**

- Redis Replica 동기화 지연에 대비한 **Fallback 캐시 로직** 추가
- 발급 이벤트 시 **큐(Streams/Kafka Outbox)** 를 통한 **비동기 처리 전환**
- 장애 탐지 및 알림 자동화 강화

---

## **3. 분석**

### **5 Whys**

1. **왜 서비스 지연이 발생했나?**
    
    → Redis 요청 응답이 4초 주기로 튀었다.
    
2. **왜 Redis 응답이 튀었나?**
    
    → Master 장애 후 Replica 동기화 지연 중이었다.
    
3. **왜 Replica 동기화에 시간이 걸렸나?**
    
    → Master 다운 시점에서 Replication backlog가 커서 full resync 발생.
    
4. **왜 backlog 기반 빠른 복구가 안됐나?**
    
    → backlog 크기 설정 부족 및 네트워크 I/O 한계로 빠른 동기화 실패.
    
5. **왜 애플리케이션에서 이를 흡수하지 못했나?**
    
    → Redis 장애/지연을 대비한 Fallback 메커니즘(큐 기반 처리, Graceful degradation)이 없었다.
    

---

## **4. 대응 방안**

### **액션 아이템**

### **Short-term (즉시)**

- Redis replication backlog 사이즈 조정
- 애플리케이션 레벨에서 **timeout + fallback 메시지 처리**
- 쿠폰 발급 시 로깅 및 모니터링 강화

### **Mid-term (1~2개월)**

- Redis Sentinel 구성 검증 및 **복제 지연 모니터링 대시보드** 추가
- 쿠폰 발급 트래픽을 직접 Redis에 쓰지 않고 **Redis Streams/Kafka Outbox 큐잉**으로 전환
- SLA 기반 **자동 graceful degrade 모드** (ex: “잠시 후 발급 결과 확인” UX)

### **Long-term (3개월+)**

- Redis → Redis Cluster or Multi-AZ 배포 구조 전환
- Redis 장애 시에도 일관성을 보장할 수 있는 **CQRS + Event sourcing 구조** 도입
- 클라우드 매니지드 Redis (AWS ElastiCache / GCP Memorystore) 도입 검토