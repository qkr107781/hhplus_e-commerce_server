# ğŸ“„ Redis ìºì‹œ ì ìš© ë³´ê³ ì„œ

**ì£¼ì œ:** ì¸ê¸° ìƒí’ˆ ì¡°íšŒ ê¸°ëŠ¥ ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•œ Redis ìºì‹œ ì ìš© ì „ëµ

---

## 1. ëª©ì 

Redisì— ìì£¼ ì¡°íšŒë˜ëŠ” ë°ì´í„°ë¥¼ ìºì‹±í•˜ì—¬ **ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ íšŸìˆ˜ë¥¼ ì¤„ì´ê³ **,

ì „ì²´ì ì¸ ì‹œìŠ¤í…œ ì‘ë‹µ ì†ë„ì™€ ì•ˆì •ì„±ì„ í–¥ìƒ

---

## 2. ëŒ€ìƒ

**ì¸ê¸° ìƒí’ˆ ì¡°íšŒ ê¸°ëŠ¥**

- **íŠ¹ì§•**: ì¡°íšŒ/ì“°ê¸°ê°€ ë¹ˆë²ˆí•˜ê²Œ ë°œìƒí•˜ëŠ” **ì£¼ë¬¸(Order)**, **ìƒí’ˆ(Product)** ê´€ë ¨ í…Œì´ë¸” ê¸°ë°˜ í†µê³„ ë°ì´í„°
- **ìºì‹± ëª©ì **: ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ìµœì†Œí™” ë° ë¶€í•˜ ì™„í™”

---

## 3. ë¶„ì„

- ì¸ê¸° ìƒí’ˆ ì¡°íšŒ ì¿¼ë¦¬ëŠ” **`IN`, `GROUP BY`, `ORDER BY`** ë“±ì˜ ì—°ì‚°ì´ í¬í•¨ë˜ì–´ ìˆì–´ ë‹¤ìˆ˜ì˜ ìš”ì²­ ì‹œ ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„±ì´ ë†’ìŒ.
- í•´ë‹¹ ë°ì´í„°ëŠ” **E-Commerce í•µì‹¬ í…Œì´ë¸”(ì£¼ë¬¸, ìƒí’ˆ)**ì—ì„œ ì¶”ì¶œë˜ë¯€ë¡œ ë¶€í•˜ ì‹œ ì‚¬ìš©ì ì‘ë‹µ ì§€ì—° ê°€ëŠ¥ì„± ì¡´ì¬.
- ë°ì´í„° ë³€ë™ì´ ì ê³  ì‚¬ìš©ì ìš”ì²­ì´ ì¦ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ë¯€ë¡œ **Redis ìºì‹œ ì²˜ë¦¬**ë¥¼ í†µí•´ ë°˜ë³µ ì¡°íšŒ ë¶€í•˜ë¥¼ ì¤„ì´ëŠ” ê²ƒì´ íš¨ê³¼ì ì„.

---

## 4. í•´ê²° ì „ëµ

- **ìºì‹œ í‚¤**: `top5:sales:last3days`
- **TTL (Time To Live)**: 25ì‹œê°„
- ì „ëµ: **Read Through + Write Through í˜¼í•© ì ìš©**
    - Read Through: ì‚¬ìš©ì ìš”ì²­ ì‹œ ìºì‹œ ë¨¼ì € í™•ì¸, ì—†ìœ¼ë©´ DB ì¡°íšŒ í›„ ìºì‹œ ì €ì¥
    - Write Through(ë°°ì¹˜): ì£¼ê¸°ì ìœ¼ë¡œ ìºì‹œë¥¼ ìµœì‹  ë°ì´í„°ë¡œ ê°±ì‹ 

---

### 4.1 Read Through (ì‚¬ìš©ì ìš”ì²­ ì‹œ)
![read_throught.png](read_throught.png)

```java
private static final String CACHE_NAME = "topSalesProducts";
private static final String CACHE_KEY = "'top5:sales:last3days'";
/**
 * ì˜¤ëŠ˜ ê¸°ì¤€ 4ì¼ ì „ë¶€í„° 1ì¼ ì „ê¹Œì§€ì˜ ë°ì´í„° ì¤‘ salesQuantity ê¸°ì¤€ ìƒìœ„ 5ê°œë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
 * ì˜ˆ: ì˜¤ëŠ˜ì´ 7ì›” 25ì¼ì´ë©´, 7ì›” 21ì¼ ë¶€í„° 7ì›” 24ì¼ ê¹Œì§€ì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
 * @return ìƒìœ„ 5ê°œ í†µê³„ ë°ì´í„° ë¦¬ìŠ¤íŠ¸
 */
@Cacheable(
        cacheNames = CACHE_NAME,
        key = CACHE_KEY,
        unless = "#result == null  || #result.isEmpty()"
)
@Transactional(readOnly = true)
@Override
public List<ProductResponse.Statistics> selectTop5SalesProductBySpecificRange() {
    List<OrderProduct> orderProductListByBefore3Days = new ArrayList<>();

    LocalDate endDate = LocalDate.now();
    LocalDate startDate = LocalDate.now().minusDays(3);

    List<Order> orderList = orderService.selectOrderByOrderStatusAndOrderDateBetween("complete_payment", startDate, endDate);

    //ì¶”ì¶œì¼ ê¸°ì¤€ 3ì¼ì „~1ì¼ì „ ê²°ì œ ì™„ë£Œëœ ì£¼ë¬¸ì˜ ì£¼ë¬¸ ìƒí’ˆ ì¡°íšŒ
    for (Order order : orderList){
        List<OrderProduct> orderProductList = orderProductService.selectOrderProductsByOrderIdOrderByProductOptionIdAsc(order.getOrderId());
        orderProductListByBefore3Days.addAll(orderProductList);
    }

    List<OrderProductSummary> top5OrderProductList = orderProductService.getTop5OrderProduct(orderProductListByBefore3Days);

    return productStatisticsService.selectTop5SalesProductBySpecificRange(top5OrderProductList);
}
```

**íŠ¹ì§•**

- ì‚¬ìš©ì ìš”ì²­ ì‹œ DB ë¶€í•˜ ìµœì†Œí™”
- ìºì‹œ ë¯¸ìŠ¤ ì‹œì—ë§Œ DB ì ‘ê·¼

---

### 4.2 Write Through (ë°°ì¹˜ ê¸°ë°˜ ìºì‹œ ê°±ì‹ )
![write_throught.png](write_throught.png)

```java
private static final String CACHE_NAME = "topSalesProducts";
private static final String CACHE_KEY = "'top5:sales:last3days'";

@CachePut(
        cacheNames = CACHE_NAME,
        key = CACHE_KEY
)
@Scheduled(cron = "0 0 0 * * *") // ë§¤ì¼ 0:00 ì‹¤í–‰
public List<ProductResponse.Statistics> productStatisticsCache() {
    List<OrderProduct> orderProductListByBefore3Days = new ArrayList<>();

    LocalDate endDate = LocalDate.now();
    LocalDate startDate = LocalDate.now().minusDays(3);

    List<Order> orderList = orderService.selectOrderByOrderStatusAndOrderDateBetween("complete_payment", startDate, endDate);

    //ì¶”ì¶œì¼ ê¸°ì¤€ 3ì¼ì „~1ì¼ì „ ê²°ì œ ì™„ë£Œëœ ì£¼ë¬¸ì˜ ì£¼ë¬¸ ìƒí’ˆ ì¡°íšŒ
    for (Order order : orderList){
        List<OrderProduct> orderProductList = orderProductService.selectOrderProductsByOrderIdOrderByProductOptionIdAsc(order.getOrderId());
        orderProductListByBefore3Days.addAll(orderProductList);
    }

    List<OrderProductSummary> top5OrderProductList = orderProductService.getTop5OrderProduct(orderProductListByBefore3Days);

    return productStatisticsService.selectTop5SalesProductBySpecificRange(top5OrderProductList);
}
```

**íŠ¹ì§•**

- ë°°ì¹˜ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ í†µí•´ ì •í•´ì§„ ì£¼ê¸°ë§ˆë‹¤ ìµœì‹  ë°ì´í„°ë¡œ ìºì‹œ ê°±ì‹ 
- ìºì‹œ TTLë³´ë‹¤ ì§§ì€ ì£¼ê¸°ë¡œ ê°±ì‹  ì‹œ í•­ìƒ ìµœì‹  ë°ì´í„° ì œê³µ ê°€ëŠ¥

---

## 5. ê¸°ëŒ€ íš¨ê³¼

| íš¨ê³¼ | ì„¤ëª… |
| --- | --- |
| ì„±ëŠ¥ í–¥ìƒ | ë‹¤ìˆ˜ì˜ ì¸ê¸° ìƒí’ˆ ì¡°íšŒ ìš”ì²­ì„ ìºì‹œì—ì„œ ì²˜ë¦¬í•˜ì—¬ DB ë¶€í•˜ ê°ì†Œ |
| ì•ˆì •ì„± ê°•í™” | DB ë¶€í•˜ ê¸‰ì¦ ì‹œì—ë„ ìºì‹œ ì‘ë‹µìœ¼ë¡œ ì„œë¹„ìŠ¤ ì•ˆì •ì„± ìœ ì§€ |
| ì‚¬ìš©ì ê²½í—˜ ê°œì„  | ì¡°íšŒ ì†ë„ í–¥ìƒìœ¼ë¡œ ë¹ ë¥¸ ì‘ë‹µ ì œê³µ |

---

## 6. ê²°ë¡ 

ì¸ê¸° ìƒí’ˆ ì¡°íšŒ ê¸°ëŠ¥ì— Read Through + Write Through ìºì‹œ ì „ëµì„ ì ìš©í•¨ìœ¼ë¡œì¨,

**ì¡°íšŒ ì„±ëŠ¥ì„ ê·¹ëŒ€í™”**í•˜ê³  **ë°ì´í„°ë² ì´ìŠ¤ ë¶€í•˜ ì™„í™”**

íŠ¹íˆ, **ë°°ì¹˜ ê¸°ë°˜ Write Through**ë¥¼ í†µí•´ ë°ì´í„° ìµœì‹ ì„±ê³¼ ì•ˆì •ì„±ì„ ëª¨ë‘ í™•ë³´ ê°€ëŠ¥